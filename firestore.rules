rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Users can only read/write their own data
    match /users/{userId} {
      allow read, write: if isOwner(userId);
    }
    
    // Patients accessible only to their guardians or assigned clinician
    match /patients/{patientId} {
      allow read: if isAuthenticated() && (
        request.auth.uid in resource.data.guardians ||
        request.auth.uid == resource.data.assignedClinician ||
        isAdmin()
      );
      allow write: if isAuthenticated() && request.auth.uid in resource.data.guardians;
    }
    
    // Onboarding applications - owner access only
    match /onboardingApplications/{applicationId} {
      allow read, write: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        request.resource.data.userId == request.auth.uid
      );
    }
    
    // Conversations - owner access with 90-day TTL enforcement
    match /conversations/{conversationId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
      allow delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid && 
        resource.data.userDeletionRequested == true
      ) || isAdmin();
    }
    
    // Clinicians and availability - read by authenticated users (for matching)
    match /clinicians/{clinicianId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Insurance coverages - read by authenticated users (for verification), write by guardians only
    match /insuranceCoverages/{coverageId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && 
                    request.auth.uid in get(/databases/$(database)/documents/patients/$(resource.data.patientId)).data.guardians;
    }
    
    // Clinician availabilities - read by authenticated users (for scheduling)
    match /clinicianAvailabilities/{availabilityId} {
      allow read: if isAuthenticated();
      // Allow updating booking status when creating an appointment
      allow update: if isAuthenticated() && 
                     // Ensure only booking-related fields can be updated
                     request.resource.data.careProviderProfileId == resource.data.careProviderProfileId &&
                     request.resource.data.rangestart == resource.data.rangestart &&
                     request.resource.data.rangeend == resource.data.rangeend;
      allow create, delete: if isAdmin();
    }
    
    // Clinician credentialed insurances - read by authenticated users (for matching)
    match /clinicianCredentialedInsurances/{junctionId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Credentialed insurances - read by authenticated users
    match /credentialedInsurances/{insuranceId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Referral members - guardian access
    match /referralMembers/{memberId} {
      allow read: if isAuthenticated() && 
                  request.auth.uid in get(/databases/$(database)/documents/referrals/$(resource.data.referralId)).data.guardians;
    }
    
    // Contracts - read by authenticated users
    match /contracts/{contractId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Org contracts - read by authenticated users
    match /orgContracts/{orgContractId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Appointments - accessible to patient guardian and assigned clinician
    match /appointments/{appointmentId} {
      // Allow creating appointments for authenticated users
      allow create: if isAuthenticated() && 
                     request.resource.data.keys().hasAll(['clinicianId', 'dateTime', 'status']);
      
      // Allow reading appointments if user is the clinician or has access via onboarding application
      allow read: if isAuthenticated() && (
        request.auth.uid == resource.data.clinicianId ||
        // Check if user owns the onboarding application
        (resource.data.applicationId != null && 
         get(/databases/$(database)/documents/onboardingApplications/$(resource.data.applicationId)).data.userId == request.auth.uid) ||
        // Or if patientId exists and user is a guardian (with null check)
        (resource.data.patientId != null && 
         exists(/databases/$(database)/documents/patients/$(resource.data.patientId)) &&
         request.auth.uid in get(/databases/$(database)/documents/patients/$(resource.data.patientId)).data.guardians)
      );
      
      // Allow updating appointments if user is the clinician or owns the application
      allow update: if isAuthenticated() && (
        request.auth.uid == resource.data.clinicianId ||
        (resource.data.applicationId != null && 
         get(/databases/$(database)/documents/onboardingApplications/$(resource.data.applicationId)).data.userId == request.auth.uid) ||
        (resource.data.patientId != null && 
         exists(/databases/$(database)/documents/patients/$(resource.data.patientId)) &&
         request.auth.uid in get(/databases/$(database)/documents/patients/$(resource.data.patientId)).data.guardians)
      );
    }
    
    // Questionnaires - guardian access only
    match /questionnaires/{questionnaireId} {
      allow read: if isAuthenticated() && 
                  request.auth.uid in get(/databases/$(database)/documents/patients/$(resource.data.patientId)).data.guardians;
    }
    
    // Referrals - guardian access
    match /referrals/{referralId} {
      allow read: if isAuthenticated() && 
                  request.auth.uid in get(/databases/$(database)/documents/patients/$(resource.data.patientId)).data.guardians;
    }
    
    // Knowledge base - read-only for all authenticated users
    match /knowledgeBase/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Organizations - read by authenticated (for display purposes)
    match /organizations/{orgId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Support chats - users can create and read their own chats, support team can read all active chats
    match /supportChats/{chatId} {
      // Users can create their own chats
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      // Users can read and update their own chats
      allow read, update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        resource.data.assignedTo == request.auth.uid ||
        isAdmin()
      );
      
      // Support team can read all active chats and update assigned chats
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        resource.data.status == 'active' ||
        isAdmin()
      );
      
      // Support team can send messages and assign/resolve chats
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        resource.data.assignedTo == request.auth.uid ||
        isAdmin()
      );
    }
  }
}

